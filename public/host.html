<!DOCTYPE html>
<html lang="en">
<head>
    <title>HOST PLAYER (ADMIN)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ctp: {
                            base: '#1e1e2e',
                            mantle: '#181825',
                            crust: '#11111b',
                            text: '#cdd6f4',
                            subtext0: '#a6adc8',
                            surface0: '#313244',
                            surface1: '#45475a',
                            blue: '#89b4fa',
                            red: '#f38ba8',
                            green: '#a6e3a1',
                            yellow: '#f9e2af',
                            mauve: '#cba6f7',
                            peach: '#fab387'
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-black text-ctp-text h-screen flex flex-col items-center justify-center overflow-hidden">

    <!-- CRT Effect Overlay (Optional aesthetic) -->
    <div class="fixed inset-0 crt-overlay z-50 opacity-20 pointer-events-none"></div>

    <div class="z-10 w-full max-w-4xl p-6 flex flex-col items-center">
        
        <!-- Status Header -->
        <div class="w-full flex justify-between items-center mb-6 border-b border-ctp-surface1 pb-4">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-ctp-green rounded-full animate-pulse shadow-[0_0_10px_#a6e3a1]"></div>
                <h1 class="text-xl font-bold tracking-widest text-ctp-green">SYSTEM :: HOST_PLAYER</h1>
            </div>
            <div class="text-xs text-ctp-surface1">v1.0.0-stable</div>
        </div>

        <!-- Start Button (Overlay) -->
        <div id="startOverlay" class="absolute inset-0 bg-black/90 z-40 flex flex-col items-center justify-center backdrop-blur-sm">
            <div class="text-ctp-red mb-4 text-center">
                <div class="text-6xl mb-2">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold">SYSTEM LOCKED</h2>
                <p class="text-ctp-subtext0 mt-2">Browser autoplay policy requires user interaction.</p>
            </div>
            <button onclick="startSystem()" 
                class="group relative px-8 py-4 bg-ctp-surface0 overflow-hidden rounded-lg border border-ctp-red text-ctp-red font-bold hover:bg-ctp-red hover:text-ctp-base transition-all duration-300">
                <span class="relative z-10">INITIALIZE SYSTEM</span>
                <div class="absolute inset-0 h-full w-full scale-0 rounded-lg transition-all duration-300 group-hover:scale-100 group-hover:bg-ctp-red"></div>
            </button>
        </div>
        
        <!-- Player Container -->
        <div class="relative w-full aspect-video bg-ctp-mantle border-2 border-ctp-surface1 rounded-lg overflow-hidden shadow-[0_0_30px_rgba(0,0,0,0.5)]">
            <div id="player" class="w-full h-full"></div>
            
            <!-- Overlay Info when idle -->
            <div id="idleState" class="absolute inset-0 flex items-center justify-center bg-ctp-base/80 z-0 pointer-events-none">
                <div class="text-center">
                    <div class="text-4xl animate-bounce mb-2">üí§</div>
                    <div class="text-ctp-subtext0 tracking-widest text-sm">WAITING FOR REQUESTS...</div>
                </div>
            </div>
        </div>

        <!-- Controls / Info -->
        <div class="w-full mt-6 flex gap-4 items-stretch">
            <!-- Status & Metadata Group -->
            <div class="flex-1 bg-ctp-mantle rounded-xl border border-ctp-surface0 p-4 flex items-center justify-between shadow-lg">
                <div class="flex flex-col border-r border-ctp-surface1 pr-6 mr-6 min-w-[120px]">
                    <div class="text-[10px] text-ctp-overlay0 uppercase tracking-[0.2em] mb-1">Status</div>
                    <div id="statusText" class="text-ctp-yellow font-bold text-sm">IDLE</div>
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] text-ctp-overlay0 uppercase tracking-[0.2em] mb-1">Now Playing</div>
                    <div class="flex flex-col">
                        <div id="currentInfo" class="text-ctp-blue font-bold text-sm truncate leading-tight">---</div>
                        <div id="currentArtist" class="text-ctp-subtext0 text-[11px] truncate mt-0.5">---</div>
                    </div>
                </div>

                <!-- Sleek Skip Button -->
                <button onclick="skipSong()" 
                    class="ml-6 group relative p-3 rounded-full bg-ctp-surface0 text-ctp-red hover:bg-ctp-red hover:text-ctp-base transition-all duration-300 shadow-lg hover:shadow-[0_0_15px_rgba(243,139,168,0.4)] active:scale-90"
                    title="Skip Song">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 18L14.5 12L6 6V18ZM16 6V18H18V6H16Z" />
                    </svg>
                    <!-- Tooltip hint -->
                    <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-ctp-surface1 text-ctp-text text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                        SKIP TRACK
                    </span>
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;
        let isReady = false;

        // 1. Load IFrame API YouTube
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 2. Setup Player
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'controls': 1,      // Show controls
                    'disablekb': 0,     // Enable keyboard
                    'fs': 1,            // Enable fullscreen
                    'rel': 0            // Disable related videos at end
                },
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            console.log("Player API Ready");
        }

        // 3. Detect when song ends
        function onPlayerStateChange(event) {
            // State 0 means ENDED
            if (event.data === 0) {
                console.log("Song ended, requesting next...");
                setStatus("ENDING_TRACK", "text-ctp-red");
                socket.emit('song_ended'); 
                document.getElementById('idleState').style.display = 'flex';
            } else if (event.data === 1) { // Playing
                setStatus("PLAYING", "text-ctp-green");
                document.getElementById('idleState').style.display = 'none';
            } else if (event.data === 2) { // Paused
                setStatus("PAUSED", "text-ctp-peach");
            }
        }

        // 4. Start Function (Autoplay Policy workaround)
        function startSystem() {
            isReady = true;
            socket.emit('song_ended'); // Trigger server to send first song
            
            // UI Updates
            const overlay = document.getElementById('startOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
            
            setStatus("ACTIVE - WAITING", "text-ctp-blue");
        }

        function setStatus(text, colorClass) {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.className = `font-bold ${colorClass}`;
        }

        // 5. Receive Play command from Server
        socket.on('play_next', (song) => {
            if(song && isReady) {
                console.log("Playing:", song.title);
                
                // Update UI Info
                document.getElementById('currentInfo').innerText = song.title;
                document.getElementById('currentArtist').innerText = song.artist || "Unknown Artist";

                // Ensure player exists
                if(player && player.loadVideoById) {
                    player.loadVideoById(song.id);
                }
            }
        });

        // 6. Skip Function
        function skipSong() {
            if(isReady) {
                console.log("Skipping song...");
                setStatus("SKIPPING...", "text-ctp-red");
                
                // Stop player to avoid audio overlap
                if(player && player.stopVideo) {
                    player.stopVideo();
                }

                // Force server to send next song
                socket.emit('song_ended');
            }
        }
    </script>
</body>
</html>